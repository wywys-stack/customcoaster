<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Coasters — Designer</title>

  <style>
    :root{
      --bg:#fbf6ee;
      --ink:#1f1a15;
      --muted:#6b5f55;
      --card:#fffaf2;
      --line:#e7dccf;
      --shadow:0 12px 28px rgba(31,26,21,.10);
      --accent:#c65a2e;
      --chip:#f3e7d8;
      --focus:0 0 0 3px rgba(198,90,46,.22);
      --radius2:24px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1100px 700px at 10% -10%, #ffe8cf 0%, transparent 60%),
        radial-gradient(900px 650px at 105% 0%, #d6f0ea 0%, transparent 55%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:blur(8px);
      background:rgba(251,246,238,.78);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand-left{display:flex;align-items:center;gap:12px}
    .mark{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(145deg, rgba(198,90,46,.95), rgba(30,111,92,.9));
      box-shadow:0 10px 22px rgba(31,26,21,.12);
      position:relative;
    }
    .mark:after{
      content:""; position:absolute; inset:9px;
      border-radius:12px; background:rgba(251,246,238,.65);
      transform:rotate(10deg);
    }
    h1{font-size:16px;margin:0}
    .sub{margin:0;font-size:12px;color:var(--muted)}
    .cta-mini{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted)}
    .pill{
      padding:8px 10px;border-radius:999px;background:var(--chip);
      border:1px solid var(--line);font-family:var(--mono)
    }

    main .wrap{
      padding:18px 16px 36px;
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width:980px){ main .wrap{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:baseline;justify-content:space-between;gap:12px;
    }
    .card-head h2{margin:0;font-size:14px}
    .card-head .hint{font-size:12px;color:var(--muted)}
    .card-body{padding:14px 16px 16px}

    .grid{display:grid;gap:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

    select,input[type="text"],input[type="number"],input[type="range"]{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    input[type="range"]{height:42px;padding:10px}
    select:focus,input:focus{box-shadow:var(--focus);border-color:rgba(198,90,46,.55)}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:560px){ .row2,.row3{grid-template-columns:1fr} }

    .divider{height:1px;background:var(--line);margin:12px 0}

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      border-radius:999px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
      transition:transform .05s ease, box-shadow .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(31,26,21,.10)}
    .btn:active{transform:translateY(0);box-shadow:none}
    .btn.primary{
      border-color:rgba(198,90,46,.4);
      background:linear-gradient(135deg, rgba(198,90,46,.95), rgba(198,90,46,.78));
      color:#fff;
    }
    .btn.ghost{background:transparent}
    .btn.danger{
      border-color:rgba(198,90,46,.25);
      background:rgba(198,90,46,.08);
      color:#6d2d17;
    }

    .uploader{
      border:1px dashed rgba(31,26,21,.25);
      background:rgba(255,255,255,.6);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .uploader .meta{display:flex;flex-direction:column;gap:3px;min-width:0}
    .uploader .meta b{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .uploader .meta span{font-size:12px;color:var(--muted)}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;
      cursor:pointer;font-size:12px;
    }
    .chip input{accent-color:var(--accent)}
    .swatch{width:12px;height:12px;border-radius:999px;border:1px solid rgba(31,26,21,.18)}

    details summary{
      cursor:pointer; user-select:none; list-style:none;
      font-size:12px; color:var(--muted);
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.45);
      border-radius:16px;
    }
    details summary::-webkit-details-marker{display:none}
    details[open] summary{box-shadow:var(--focus);border-color:rgba(198,90,46,.35)}

    .note{
      background:rgba(30,111,92,.08);
      border:1px solid rgba(30,111,92,.18);
      padding:10px 12px;
      border-radius:16px;
      color:#164b3f;
      font-size:12px;
      line-height:1.35;
    }
    .warn{
      background:rgba(198,90,46,.08);
      border:1px solid rgba(198,90,46,.18);
      color:#6d2d17;
    }

    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:var(--mono)}
    .sr{position:absolute;left:-9999px}

    /* Preview */
    .preview{display:grid;gap:14px}
    .stage{padding:16px}
    .stage-top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .stage-top .title{display:flex;flex-direction:column;gap:2px}
    .stage-top .title b{font-size:14px}
    .stage-top .title span{font-size:12px;color:var(--muted)}

    .canvas-shell{
      border-radius:26px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.25));
      padding:14px;
    }
    .canvas-inner{
      display:grid;place-items:center;
      background:rgba(31,26,21,.04);
      border-radius:20px;
      padding:18px;
      overflow:hidden;
    }
    canvas{
      width:min(520px, 92vw);
      height:auto;
      display:block;
      border-radius:18px;
      box-shadow:0 16px 28px rgba(31,26,21,.14);
      background:#fff;
    }

    .stage-actions{
      display:flex;flex-wrap:wrap;gap:10px;
      align-items:center;justify-content:space-between;
      margin-top:12px;
    }
    .stage-actions .left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.6);
      font-size:12px;color:var(--muted);line-height:1.35;
    }
    .status b{color:var(--ink)}
    .status a{color:inherit}

    .linkbox{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    .linkrow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      background:rgba(255,255,255,.55);
    }
    .linkrow .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .linkrow .meta b{font-size:12px;color:var(--muted)}
    .linkrow .meta .val{
      font-family:var(--mono);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Material texture manager */
    .texture-list{display:grid;gap:10px;margin-top:10px}
    .tex-row{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.55);
    }
    .tex-left{display:flex;gap:10px;align-items:center;min-width:0}
    .tex-thumb{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--line);background:#fff;overflow:hidden;flex:0 0 auto;
    }
    .tex-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .tex-meta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .tex-meta b{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tex-meta span{font-size:12px;color:var(--muted)}
    .tex-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  </style>

  <!-- Uploadcare (hosts files) -->
  <script>UPLOADCARE_LOCALE="en";</script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="brand-left">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1>Custom Coasters</h1>
          <p class="sub">Shape · Material · Size · Upload logo · Add text · Pick fonts</p>
        </div>
      </div>
      <div class="cta-mini">
        <span class="pill">hosted uploads</span>
        <span class="pill">no email</span>
        <span class="pill">1-page</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- Controls -->
    <section class="card">
      <div class="card-head">
        <h2>Design</h2>
        <div class="hint">Fast + clean</div>
      </div>

      <div class="card-body">
        <div class="grid">

          <div class="row2">
            <div>
              <label for="shape">Shape</label>
              <select id="shape">
                <option value="round">Round</option>
                <option value="square">Square</option>
                <option value="hex">Hex</option>
              </select>
            </div>
            <div>
              <label for="size">Size</label>
              <select id="size">
                <option value="3.5">3.5"</option>
                <option value="4.0" selected>4.0"</option>
                <option value="4.5">4.5"</option>
              </select>
            </div>
          </div>

          <div>
            <label>Material</label>
            <div class="chips" id="materials"></div>
          </div>

          <details>
            <summary>Material texture photos (optional)</summary>
            <div class="small" style="margin-top:8px;">
              Upload your real wood/slate photos here (saved in your browser). These textures appear behind the engraving preview.
            </div>
            <div class="texture-list" id="textureList"></div>
            <div class="note" style="margin-top:10px;">
              Tip: square-ish photos (800×800+) look best.
            </div>
          </details>

          <div class="divider"></div>

          <!-- Hosted artwork upload -->
          <div>
            <label>Logo / Artwork overlay</label>
            <div class="uploader">
              <div class="meta">
                <b id="artName">No file uploaded yet</b>
                <span>Upload is hosted — you’ll get a shareable link</span>
              </div>
              <div>
                <button type="button" class="btn" id="artPick">Upload</button>
              </div>
            </div>

            <div class="row2" style="margin-top:10px;">
              <div>
                <label for="logoPos">Logo placement</label>
                <select id="logoPos">
                  <option value="top">Top</option>
                  <option value="center" selected>Center</option>
                  <option value="bottom">Bottom</option>
                </select>
              </div>
              <div>
                <label for="logoScale">Logo scale <span class="small mono" id="logoScaleLabel">1.00×</span></label>
                <input id="logoScale" type="range" min="0.55" max="1.55" step="0.01" value="1.00"/>
              </div>
            </div>

            <div class="note warn" style="margin-top:10px;">
              Best results: high-contrast logos. Light/white areas won’t “burn” and may disappear in the preview (like a real laser).
            </div>
          </div>

          <div class="divider"></div>

          <!-- Text line 1 -->
          <div>
            <label>Text line 1</label>
            <div class="row3">
              <input id="t1Text" type="text" placeholder="e.g., WY WY MAKES" value="" />
              <select id="t1Font">
                <option value="Garamond, Georgia, serif">Classic Serif (Garamond)</option>
                <option value="'Palatino Linotype', Palatino, serif">Warm Serif (Palatino)</option>
                <option value="'Trebuchet MS', system-ui, sans-serif" selected>Modern Sans (Trebuchet)</option>
                <option value="system-ui, -apple-system, Segoe UI, Roboto, sans-serif">Clean Sans (System)</option>
                <option value="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">Mono (Tech)</option>
              </select>
              <select id="t1Pos">
                <option value="top">Top</option>
                <option value="center" selected>Center</option>
                <option value="bottom">Bottom</option>
              </select>
            </div>
            <div style="height:10px"></div>
            <div class="row2">
              <div>
                <label for="t1Size">Line 1 size</label>
                <input id="t1Size" type="number" min="10" max="90" step="1" value="36" />
              </div>
              <div class="note">
                Keep line 1 short for the cleanest engraving.
              </div>
            </div>
          </div>

          <!-- Text line 2 -->
          <div>
            <label>Text line 2</label>
            <div class="row3">
              <input id="t2Text" type="text" placeholder="e.g., EST. 2026 / CHULA VISTA" value="" />
              <select id="t2Font">
                <option value="Garamond, Georgia, serif">Classic Serif (Garamond)</option>
                <option value="'Palatino Linotype', Palatino, serif" selected>Warm Serif (Palatino)</option>
                <option value="'Trebuchet MS', system-ui, sans-serif">Modern Sans (Trebuchet)</option>
                <option value="system-ui, -apple-system, Segoe UI, Roboto, sans-serif">Clean Sans (System)</option>
                <option value="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">Mono (Tech)</option>
              </select>
              <select id="t2Pos">
                <option value="top">Top</option>
                <option value="center">Center</option>
                <option value="bottom" selected>Bottom</option>
              </select>
            </div>
            <div style="height:10px"></div>
            <div class="row2">
              <div>
                <label for="t2Size">Line 2 size</label>
                <input id="t2Size" type="number" min="10" max="90" step="1" value="28" />
              </div>
              <div class="note warn">
                Super small text may fade in real laser results.
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="note">
            This page hosts your uploads and proof image. You can paste the hosted links into Big Cartel order notes or keep them for production.
          </div>
        </div>
      </div>
    </section>

    <!-- Preview -->
    <section class="preview">
      <section class="card stage">
        <div class="stage-top">
          <div class="title">
            <b>Preview</b>
            <span>Laser-style engraving simulation (dark burn look)</span>
          </div>
          <div class="small mono" id="summary"></div>
        </div>

        <div class="canvas-shell">
          <div class="canvas-inner">
            <canvas id="cv" width="900" height="900" aria-label="Coaster preview"></canvas>
          </div>
        </div>

        <div class="stage-actions">
          <div class="left">
            <button type="button" class="btn" id="downloadPng">Download proof PNG</button>
            <button type="button" class="btn" id="copyCode">Copy design code</button>
            <button type="button" class="btn primary" id="submitDesign">Submit (host proof)</button>
          </div>
          <div class="small">
            Submit uploads the proof PNG and shows hosted links below.
          </div>
        </div>

        <div class="status" id="statusBox">
          <b>Status:</b> Ready. Upload artwork, tweak your design, then click <b>Submit</b>.
        </div>

        <div class="linkbox" id="linkBox" style="display:none;">
          <div class="linkrow">
            <div class="meta">
              <b>Hosted artwork URL</b>
              <div class="val" id="artUrlVal">—</div>
            </div>
            <button type="button" class="btn" id="copyArtUrl">Copy</button>
          </div>

          <div class="linkrow">
            <div class="meta">
              <b>Hosted proof PNG URL</b>
              <div class="val" id="proofUrlVal">—</div>
            </div>
            <button type="button" class="btn" id="copyProofUrl">Copy</button>
          </div>

          <div class="linkrow">
            <div class="meta">
              <b>Design code</b>
              <div class="val" id="codeVal">—</div>
            </div>
            <button type="button" class="btn" id="copyCode2">Copy</button>
          </div>
        </div>

      </section>
    </section>

  </div>
</main>

<script>
/* =========================================================
   CONFIG — REQUIRED
   ========================================================= */
const UPLOADCARE_PUBLIC_KEY = 53eeccec14419f6dd5c8; // <-- set this

/* =========================================================
   APP
   ========================================================= */
const MATERIALS = [
  { id:"birch",  name:"Birch",  tone:"#e7d2b3" },
  { id:"walnut", name:"Walnut", tone:"#6a4b34" },
  { id:"bamboo", name:"Bamboo", tone:"#d9c38f" },
  { id:"cork",   name:"Cork",   tone:"#c2a47a" },
  { id:"slate",  name:"Slate",  tone:"#4b4d52" }
];

const KEYS = { textures: "coaster_material_textures_v1" };
const $ = (id)=>document.getElementById(id);

// Canvas
const cv = $("cv");
const ctx = cv.getContext("2d");

// Controls
const elShape = $("shape");
const elSize  = $("size");
const summary = $("summary");

const artPick = $("artPick");
const artName = $("artName");

const elLogoPos = $("logoPos");
const elLogoScale = $("logoScale");
const elLogoScaleLabel = $("logoScaleLabel");

const t1Text = $("t1Text");
const t1Font = $("t1Font");
const t1Pos  = $("t1Pos");
const t1Size = $("t1Size");

const t2Text = $("t2Text");
const t2Font = $("t2Font");
const t2Pos  = $("t2Pos");
const t2Size = $("t2Size");

// Actions
const downloadPng = $("downloadPng");
const copyCodeBtn = $("copyCode");
const submitDesign = $("submitDesign");
const statusBox = $("statusBox");

// Link box
const linkBox = $("linkBox");
const artUrlVal = $("artUrlVal");
const proofUrlVal = $("proofUrlVal");
const codeVal = $("codeVal");
const copyArtUrl = $("copyArtUrl");
const copyProofUrl = $("copyProofUrl");
const copyCode2 = $("copyCode2");

// State
const state = {
  material: MATERIALS[0].id,
  shape: "round",
  size: 4.0,

  // hosted artwork
  artUrl: "",          // Uploadcare CDN URL
  artPreviewUrl: "",   // scaled preview URL
  artImage: null,

  logoPos: "center",
  logoScale: 1.00,

  line1: { text:"", font: t1Font.value, pos:"center", size: 36 },
  line2: { text:"", font: t2Font.value, pos:"bottom", size: 28 },

  // textures stored locally
  textureMap: loadTextureMap(),        // { materialId: dataURL }
  textureImgCache: {}                  // { materialId: Image() }
};

// Init Uploadcare
if (UPLOADCARE_PUBLIC_KEY && !UPLOADCARE_PUBLIC_KEY.includes("PASTE_")) {
  uploadcare.publicKey = UPLOADCARE_PUBLIC_KEY;
}

// Build material chips
const materialsWrap = $("materials");
MATERIALS.forEach((m, idx)=>{
  const lab = document.createElement("label");
  lab.className = "chip";
  lab.innerHTML = `
    <input type="radio" name="mat" value="${m.id}" ${idx===0?"checked":""} />
    <span class="swatch" style="background:${m.tone}"></span>
    <span>${m.name}</span>
  `;
  lab.addEventListener("change", ()=>{
    state.material = m.id;
    render();
  });
  materialsWrap.appendChild(lab);
});

// Texture manager UI
const textureList = $("textureList");
function renderTextureManager(){
  textureList.innerHTML = "";
  MATERIALS.forEach((m)=>{
    const dataUrl = state.textureMap[m.id] || "";
    const row = document.createElement("div");
    row.className = "tex-row";

    row.innerHTML = `
      <div class="tex-left">
        <div class="tex-thumb">${dataUrl ? `<img alt="${m.name} texture" src="${dataUrl}">` : ""}</div>
        <div class="tex-meta">
          <b>${m.name} texture</b>
          <span>${dataUrl ? "Custom photo loaded" : "No custom photo (uses flat tone)"}</span>
        </div>
      </div>
      <div class="tex-actions">
        <input class="sr" type="file" accept="image/*" id="texFile_${m.id}">
        <button type="button" class="btn ghost" id="texUp_${m.id}">Upload</button>
        <button type="button" class="btn danger" id="texClr_${m.id}" ${dataUrl ? "" : "disabled"}>Clear</button>
      </div>
    `;
    textureList.appendChild(row);

    const f = row.querySelector(`#texFile_${m.id}`);
    const up = row.querySelector(`#texUp_${m.id}`);
    const clr = row.querySelector(`#texClr_${m.id}`);

    up.addEventListener("click", (e)=>{ e.preventDefault(); f.click(); });
    f.addEventListener("change", async ()=>{
      const file = f.files && f.files[0];
      if(!file) return;
      const url = await fileToDataURL(file);
      state.textureMap[m.id] = url;
      saveTextureMap(state.textureMap);
      state.textureImgCache[m.id] = null;
      renderTextureManager();
      render();
    });

    clr.addEventListener("click", ()=>{
      delete state.textureMap[m.id];
      saveTextureMap(state.textureMap);
      state.textureImgCache[m.id] = null;
      renderTextureManager();
      render();
    });
  });
}

// Inputs
elShape.addEventListener("change", ()=>{ state.shape = elShape.value; render(); });
elSize.addEventListener("change", ()=>{ state.size = parseFloat(elSize.value); render(); });

elLogoPos.addEventListener("change", ()=>{ state.logoPos = elLogoPos.value; render(); });
elLogoScale.addEventListener("input", ()=>{
  state.logoScale = clamp(parseFloat(elLogoScale.value), 0.55, 1.55);
  elLogoScaleLabel.textContent = state.logoScale.toFixed(2) + "×";
  render();
});

// Text lines
t1Text.addEventListener("input", ()=>{ state.line1.text = t1Text.value; render(); });
t1Font.addEventListener("change", ()=>{ state.line1.font = t1Font.value; render(); });
t1Pos .addEventListener("change", ()=>{ state.line1.pos  = t1Pos.value; render(); });
t1Size.addEventListener("input", ()=>{ state.line1.size = clamp(parseInt(t1Size.value||"36",10),10,90); render(); });

t2Text.addEventListener("input", ()=>{ state.line2.text = t2Text.value; render(); });
t2Font.addEventListener("change", ()=>{ state.line2.font = t2Font.value; render(); });
t2Pos .addEventListener("change", ()=>{ state.line2.pos  = t2Pos.value; render(); });
t2Size.addEventListener("input", ()=>{ state.line2.size = clamp(parseInt(t2Size.value||"28",10),10,90); render(); });

// Hosted artwork upload
artPick.addEventListener("click", async (e)=>{
  e.preventDefault();
  if (!UPLOADCARE_PUBLIC_KEY || UPLOADCARE_PUBLIC_KEY.includes("PASTE_")) {
    setStatus("Add your Uploadcare public key in CONFIG and reload.", true);
    return;
  }

  setStatus("Opening uploader…", false);

  const dialog = uploadcare.openDialog(null, {
    publicKey: UPLOADCARE_PUBLIC_KEY,
    imagesOnly: false,
    multiple: false
  });

  dialog.done((file)=>{
    setStatus("Uploading artwork…", false);
    file.done(async (info)=>{
      state.artUrl = info.cdnUrl;
      state.artPreviewUrl = info.cdnUrl + "-/preview/1024x1024/";
      artName.textContent = info.name || "Artwork uploaded";

      // show links immediately
      linkBox.style.display = "grid";
      artUrlVal.textContent = state.artUrl;

      await loadImageIntoState(state.artPreviewUrl);
      setStatus("Artwork uploaded & hosted. Preview updated.", false);
      render();
    }).fail(()=>{
      setStatus("Upload failed. Try again.", true);
    });
  }).fail(()=>{
    setStatus("Upload canceled.", false);
  });
});

// Preview export
downloadPng.addEventListener("click", ()=>{
  const a = document.createElement("a");
  a.download = "coaster-proof.png";
  a.href = cv.toDataURL("image/png");
  a.click();
});

copyCodeBtn.addEventListener("click", ()=> copyText(buildDesignCode(), copyCodeBtn, "Copied!"));
copyArtUrl.addEventListener("click", ()=> copyText(state.artUrl || "", copyArtUrl, "Copied!"));
copyProofUrl.addEventListener("click", ()=> copyText(proofUrlVal.textContent || "", copyProofUrl, "Copied!"));
copyCode2.addEventListener("click", ()=> copyText(buildDesignCode(), copyCode2, "Copied!"));

// Submit: upload proof PNG to Uploadcare
submitDesign.addEventListener("click", async ()=>{
  if (!UPLOADCARE_PUBLIC_KEY || UPLOADCARE_PUBLIC_KEY.includes("PASTE_")) {
    setStatus("Add your Uploadcare public key in CONFIG and reload.", true);
    return;
  }
  if (!state.artUrl) {
    setStatus("Upload artwork first so the design is complete.", true);
    return;
  }

  try{
    setStatus("Uploading proof PNG…", false);

    // Create proof and upload to Uploadcare
    const proofDataUrl = cv.toDataURL("image/png");
    const proofFile = uploadcare.fileFrom("base64", proofDataUrl, "coaster-proof.png");
    const proofInfo = await proofFile.done();
    const proofUrl = proofInfo.cdnUrl;

    linkBox.style.display = "grid";
    proofUrlVal.textContent = proofUrl;
    codeVal.textContent = buildDesignCode();

    setStatus("Done. Proof hosted — copy the links below.", false);
  }catch(err){
    console.error(err);
    setStatus("Proof upload failed. Check console and Uploadcare settings.", true);
  }
});

async function loadImageIntoState(url){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>{ state.artImage = img; resolve(); };
    img.onerror = reject;
    img.src = url;
  });
}

function setStatus(msg, isError){
  statusBox.innerHTML = `<b>Status:</b> ${escapeHtml(msg)}`;
  statusBox.style.borderColor = isError ? "rgba(198,90,46,.35)" : "rgba(231,220,207,1)";
  statusBox.style.background  = isError ? "rgba(198,90,46,.08)" : "rgba(255,255,255,.6)";
  statusBox.style.color       = isError ? "#6d2d17" : "var(--muted)";
}

async function copyText(text, btn, label){
  const t = (text || "").trim();
  if(!t){
    setStatus("Nothing to copy yet.", true);
    return;
  }
  try{
    await navigator.clipboard.writeText(t);
    const old = btn.textContent;
    btn.textContent = label || "Copied!";
    setTimeout(()=>btn.textContent = old, 800);
  }catch{
    alert(t);
  }
}

function buildDesignCode(){
  const mat = state.material;
  const shp = state.shape;
  const sz  = state.size.toFixed(1);
  const lp  = state.logoPos;
  const ls  = state.logoScale.toFixed(2);
  const t1  = (state.line1.text||"").trim().slice(0,60);
  const t2  = (state.line2.text||"").trim().slice(0,60);
  const f1  = shortenFont(state.line1.font);
  const f2  = shortenFont(state.line2.font);
  const art = state.artUrl ? state.artUrl : "";
  return `COASTER|mat:${mat}|shape:${shp}|size:${sz}|logoPos:${lp}|logoScale:${ls}|f1:${f1}|t1:${t1}|f2:${f2}|t2:${t2}|art:${art}`;
}
function shortenFont(font){
  return (font||"").split(",")[0].replace(/['"]/g,"").trim().slice(0,18);
}

/* ============================
   Rendering (laser preview)
   ============================ */
function render(){
  const mat = MATERIALS.find(m=>m.id===state.material) || MATERIALS[0];
  summary.textContent = `${mat.name} · ${state.shape} · ${state.size.toFixed(1)}"`;

  ctx.clearRect(0,0,cv.width,cv.height);

  // Background
  ctx.fillStyle = "#f7efe4";
  ctx.fillRect(0,0,cv.width,cv.height);

  const pad = 85;
  const cx = cv.width/2;
  const cy = cv.height/2 + 10;
  const r  = (cv.width - pad*2) * 0.43;

  drawMaterialBase(cx, cy, r, mat);

  const engr = document.createElement("canvas");
  engr.width = cv.width;
  engr.height= cv.height;
  const ectx = engr.getContext("2d");

  ectx.save();
  clipShape(ectx, cx, cy, r, state.shape);

  // Logo
  if (state.artImage){
    const box = getSafeBox(cx, cy, r, state.shape);
    const logoBox = getLogoBox(box, state.logoPos);

    const bw = logoBox.w * 0.86 * state.logoScale;
    const bh = logoBox.h * 0.86 * state.logoScale;

    const fit = contain(state.artImage.width, state.artImage.height, bw, bh);
    const x = logoBox.x + (logoBox.w - fit.w)/2;
    const y = logoBox.y + (logoBox.h - fit.h)/2;
    ectx.drawImage(state.artImage, x, y, fit.w, fit.h);
  }

  // Text
  drawTextLine(ectx, cx, cy, r, state.shape, state.line1);
  drawTextLine(ectx, cx, cy, r, state.shape, state.line2);

  ectx.restore();

  const mask = toEngraveMask(engr);
  applyEngraving(mask, cx, cy, r, state.shape);
  drawEdge(cx, cy, r, state.shape);

  // signature
  ctx.save();
  ctx.globalAlpha = 0.30;
  ctx.fillStyle = "#1f1a15";
  ctx.font = `14px ${getComputedStyle(document.documentElement).getPropertyValue('--mono')}`;
  ctx.textAlign = "center";
  ctx.fillText("preview", cx, cv.height - 28);
  ctx.restore();
}

function drawTextLine(ectx, cx, cy, r, shape, line){
  const t = (line.text || "").trim();
  if(!t) return;

  const box = getSafeBox(cx, cy, r, shape);
  const ty = textPosY(box, line.pos);

  ectx.save();
  ectx.fillStyle = "#000";
  ectx.textAlign = "center";
  ectx.textBaseline = "middle";
  ectx.font = `${clamp(parseInt(line.size||"28",10),10,90)}px ${line.font}`;
  ectx.fillText(t, cx, ty);
  ectx.fillText(t, cx+0.5, ty);
  ectx.restore();
}

function textPosY(box, pos){
  if(pos === "top") return box.y + box.h*0.26;
  if(pos === "center") return box.y + box.h*0.56;
  return box.y + box.h*0.82;
}

function getLogoBox(box, pos){
  if(pos === "top")    return { x: box.x, y: box.y + box.h*0.06, w: box.w, h: box.h*0.38 };
  if(pos === "bottom") return { x: box.x, y: box.y + box.h*0.56, w: box.w, h: box.h*0.38 };
  return { x: box.x, y: box.y + box.h*0.18, w: box.w, h: box.h*0.44 };
}

function drawMaterialBase(cx, cy, r, mat){
  ctx.save();
  clipShape(ctx, cx, cy, r, state.shape);

  const tex = state.textureMap[mat.id];
  if (tex){
    const cached = state.textureImgCache[mat.id];
    if (cached){
      drawCover(ctx, cached, 0,0, cv.width, cv.height);
    } else {
      const img = new Image();
      img.onload = ()=>{ state.textureImgCache[mat.id] = img; render(); };
      img.src = tex;
      ctx.fillStyle = mat.tone;
      ctx.fillRect(0,0,cv.width,cv.height);
    }
  } else {
    ctx.fillStyle = mat.tone;
    ctx.fillRect(0,0,cv.width,cv.height);
  }

  const noise = makeNoisePattern(240, 240, 0.12);
  ctx.globalAlpha = 0.28;
  ctx.drawImage(noise, 0,0, cv.width, cv.height);

  const grad = ctx.createRadialGradient(cx, cy, r*0.2, cx, cy, r*1.25);
  grad.addColorStop(0, "rgba(255,255,255,0.10)");
  grad.addColorStop(1, "rgba(0,0,0,0.14)");
  ctx.globalAlpha = 1;
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,cv.width,cv.height);

  ctx.restore();
}

function applyEngraving(maskCanvas, cx, cy, r, shape){
  ctx.save();
  clipShape(ctx, cx, cy, r, shape);

  const darkLayer = document.createElement("canvas");
  darkLayer.width = cv.width;
  darkLayer.height= cv.height;
  const dctx = darkLayer.getContext("2d");
  dctx.fillStyle = "#2b1b12";
  dctx.fillRect(0,0,cv.width,cv.height);
  dctx.globalCompositeOperation = "destination-in";
  dctx.drawImage(maskCanvas, 0,0);

  ctx.globalAlpha = 0.92;
  ctx.drawImage(darkLayer, 0,0);

  ctx.globalAlpha = 0.16;
  ctx.globalCompositeOperation = "multiply";
  const charNoise = makeNoisePattern(420, 420, 0.26);
  ctx.drawImage(charNoise, 0,0, cv.width, cv.height);

  ctx.restore();
  ctx.globalCompositeOperation = "source-over";
  ctx.globalAlpha = 1;
}

function drawEdge(cx, cy, r, shape){
  ctx.save();
  ctx.lineWidth = 10;
  ctx.strokeStyle = "rgba(31,26,21,.22)";
  ctx.shadowColor = "rgba(31,26,21,.20)";
  ctx.shadowBlur = 18;
  ctx.shadowOffsetY = 10;
  drawShapePath(ctx, cx, cy, r, shape);
  ctx.stroke();

  ctx.shadowBlur = 0;
  ctx.lineWidth = 6;
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  drawShapePath(ctx, cx, cy, r*0.97, shape);
  ctx.stroke();
  ctx.restore();
}

function clipShape(c, cx, cy, r, shape){
  c.beginPath();
  if(shape === "round"){
    c.arc(cx, cy, r, 0, Math.PI*2);
  }else if(shape === "square"){
    const s = r*1.58;
    roundRectPath(c, cx - s/2, cy - s/2, s, s, r*0.16);
  }else{
    polygonPath(c, cx, cy, r*1.05, 6, -Math.PI/2);
  }
  c.closePath();
  c.clip();
}

function drawShapePath(c, cx, cy, r, shape){
  c.beginPath();
  if(shape === "round"){
    c.arc(cx, cy, r, 0, Math.PI*2);
  }else if(shape === "square"){
    const s = r*1.58;
    roundRectPath(c, cx - s/2, cy - s/2, s, s, r*0.16);
  }else{
    polygonPath(c, cx, cy, r*1.05, 6, -Math.PI/2);
  }
  c.closePath();
}

function getSafeBox(cx, cy, r, shape){
  if(shape === "round") return { x: cx - r*0.78, y: cy - r*0.78, w: r*1.56, h: r*1.56 };
  if(shape === "square"){
    const s = r*1.58;
    return { x: cx - s*0.42, y: cy - s*0.42, w: s*0.84, h: s*0.84 };
  }
  return { x: cx - r*0.78, y: cy - r*0.70, w: r*1.56, h: r*1.40 };
}

// Engrave mask: remove whites
function toEngraveMask(srcCanvas){
  const w = srcCanvas.width, h = srcCanvas.height;
  const out = document.createElement("canvas");
  out.width = w; out.height = h;
  const octx = out.getContext("2d");

  const sctx = srcCanvas.getContext("2d");
  const img = sctx.getImageData(0,0,w,h);
  const d = img.data;

  for(let i=0;i<d.length;i+=4){
    const rr = d[i], gg=d[i+1], bb=d[i+2], aa=d[i+3];
    if(aa===0){ d[i+3]=0; continue; }
    const lum = (0.2126*rr + 0.7152*gg + 0.0722*bb) / 255;

    const whiteCut = 0.92;
    const softStart= 0.70;
    let alpha = 0;

    if(lum >= whiteCut){
      alpha = 0;
    }else if(lum <= softStart){
      const t = 1 - lum;
      alpha = clamp01((t - 0.05) / 0.95);
    }else{
      const k = (whiteCut - lum) / (whiteCut - softStart);
      alpha = clamp01(k * 0.55);
    }
    alpha = Math.pow(alpha, 0.85);

    d[i]=0; d[i+1]=0; d[i+2]=0;
    d[i+3]=Math.round(alpha*255);
  }
  octx.putImageData(img,0,0);

  // soften edges
  octx.filter = "blur(0.7px)";
  const temp = document.createElement("canvas");
  temp.width=w; temp.height=h;
  temp.getContext("2d").drawImage(out,0,0);
  octx.clearRect(0,0,w,h);
  octx.drawImage(temp,0,0);
  octx.filter = "none";

  return out;
}

/* ============================
   Utils
   ============================ */
function roundRectPath(c, x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  c.moveTo(x+rr, y);
  c.arcTo(x+w, y, x+w, y+h, rr);
  c.arcTo(x+w, y+h, x, y+h, rr);
  c.arcTo(x, y+h, x, y, rr);
  c.arcTo(x, y, x+w, y, rr);
}
function polygonPath(c, cx, cy, radius, sides, rot){
  for(let i=0;i<sides;i++){
    const a = rot + i*(Math.PI*2/sides);
    const x = cx + Math.cos(a)*radius;
    const y = cy + Math.sin(a)*radius;
    if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
  }
}
function contain(w,h, maxW, maxH){
  const s = Math.min(maxW/w, maxH/h);
  return { w:w*s, h:h*s };
}
function makeNoisePattern(w,h, strength){
  const c = document.createElement("canvas");
  c.width=w; c.height=h;
  const x = c.getContext("2d");
  const img = x.createImageData(w,h);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const v = 210 + Math.random()*45;
    d[i]=v; d[i+1]=v; d[i+2]=v;
    d[i+3]=Math.round(255*strength*Math.random());
  }
  x.putImageData(img,0,0);
  return c;
}
function drawCover(c, img, x,y,w,h){
  const ir = img.width/img.height;
  const cr = w/h;
  let dw=w, dh=h, dx=x, dy=y;
  if(ir > cr){
    dh = h;
    dw = h*ir;
    dx = x - (dw - w)/2;
  }else{
    dw = w;
    dh = w/ir;
    dy = y - (dh - h)/2;
  }
  c.drawImage(img, dx, dy, dw, dh);
}
function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

// Texture storage
function loadTextureMap(){
  try{ return JSON.parse(localStorage.getItem(KEYS.textures)) || {}; }catch{ return {}; }
}
function saveTextureMap(map){
  localStorage.setItem(KEYS.textures, JSON.stringify(map || {}));
}

/* ============================
   Start
   ============================ */
renderTextureManager();
render();
setStatus("Ready. Upload artwork, tweak your design, then click Submit.", false);
</script>
</body>
</html>

